# Map Editor

The Map Editor package exists as a utility in case there are issues with mapping in the [regular manner](../../../stack_master/launch/mapping_launch.xml). Possible reasons might be:

- The physical track is very crowded (in a F1TENTH competition) and there are many static obstacles that take up track space
- There are temporary obstacles on the track that will not be there at competition-time
- Odometry is bad on the track / Cartographer is performing poorly, and the generated map is not consistent with real-life.

In these cases, the Map Editor package is a convenience to allow the 2D map generated by Cartographer to be post-processed before the [global planner](../../../planner/global_planner/README.md) is invoked.

## Usage
### 1. Mapping
1. First, a (baseline) map stil needs to be created. Launch it with:
    ```bash
    ros2 launch map_editor map_editor.launch map_name:=PLACE_DAYMONTH_VN map_editor_mapping:=True racecar_version:=NUCX
    ```
    Replace PLACE with the place where the track is, e.g. icra or hangar.

    Replace DAYMONTH with the zero-padded current day, e.g. 2805 if it is the 28th of May.

    Replace VN with the version of the map, e.g. v0 if it is the first version of the map on that day.

    Replace NUCX with the racecar version, e.g. NUC6 if you are using NUC 6.

    Drive until the map is sufficiently explored (clear trackbounds, good loop closures). You can stop anywhere.

    Close the matplotlib dialog box. This will save a baseline map (png, yaml) and pbstream file **on the Car** at the directory `race_stack/stack_master/maps`.

### 2a. Calling Global Planner on your PC
This option is useful if the network connection between the car and your computer is slow (e.g. congested network), causing SSH display forwarding to be laggy.

1. Copy map **from the car to your PC**:

    This can be done with SCP.

2. Open up the map and manually edit the `.png` file in GIMP or similar. It **should be overwritten** and not be renamed.

    If `pf_map.png` needs to be edited, do so as well. Remember that `pf_map` **must look like the real track!** This is to ensure that the Particle Filter algorithm can properly localize, if used.

3. Call the map_editor program **locally**:
    ```bash
    ros2 launch map_editor map_editor.launch map_name:=PLACE_DAYMONTH_VN map_editor_mapping:=False
    ```

    Now a window with the map should be prompted. Inspect that it makes sense. To proceed that window needs to be closed.

    Next the windows should be prompted that let you select the speed and overtaking sectors.

    Note: In the global trajectory window an arrow is appearing that sets the driving direction. If it is not in the intended direction, add the flag `reverse:=True` to the previous used command.

    ```bash
    ros2 launch map_editor map_editor.launch map_name:=PLACE_DAYMONTH_VN map_editor_mapping:=False reverse:=True
    ```

    This command will create the `speed_scaler.yaml`, `ot_sectors.yaml`, and `global_waypoints.json` files.

4. Copy map with additional information **from your PC to the car**:

    This can be done by simply copying the map of interest (a folder) from your local `race_stack/stack_master/maps` to the one on the car.

6. Congrats, you should be done. Verify by running base_system **on the car** with the new map.

### 2b. Calling Global Planner on the Car

This option does not require copying, and may be more convenient if there is a stable Wi-Fi connection. It relies on display forwarding when you SSH into the car.

1. Open up the map and manually edit the `.png` file in GIMP or similar. It **should be overwritten** and not be renamed.

    You can still run GIMP **locally** and access the file using `sftp://race_crew@car_IP` with "Files" in Ubuntu.

    If `pf_map.png` needs to be edited, do so as well. Remember that `pf_map` **must look like the real track!** This is to ensure that the Particle Filter algorithm can properly localize, if used.

2. Call the map_editor program **on the car**:
    ```bash
    ros2 launch map_editor map_editor.launch map_name:=PLACE_DAYMONTH_VN map_editor_mapping:=False
    ```

    Follow the same steps as 2a, step 3. The only difference is that map_editor runs on the car.

3. Congrats, you should be done. Verify by running base_system **on the car** with the new map.
